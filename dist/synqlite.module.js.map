{"version":3,"file":"synqlite.module.js","sources":["../src/lib/index.ts","../src/lib/constants.ts"],"sourcesContent":["import { sqlite3Worker1Promiser } from '@sqlite.org/sqlite-wasm';\nimport { SYNQLITE_BATCH_SIZE, SYNQLITE_PREFIX } from './constants.js';\nimport { Change, SynQLiteOptions, SyncableTable } from './types.js';\n// import pino from 'pino';\n\nconsole.log({ sqlite3Worker1Promiser });\n\ntype ApplyChangeParams = {\n  change: Change,\n  savepoint: string\n}\n\nconst strtimeAsISO8601 = `STRFTIME('%Y-%m-%dT%H:%M:%f','NOW')`;\n\nclass SynQLite {\n  private _db: any;\n  private _dbName: string;\n  private _synqDbId?: string;\n  private _synqPrefix?: string;\n  private _synqTables?: SyncableTable[];\n  private _synqBatchSize: number = 20;\n  private _wal = false;\n\n  utils = {\n    strtimeAsISO8601,\n    nowAsISO8601: strtimeAsISO8601,\n    utcNowAsISO8601: (): string => {\n      return new Date((new Date()).toUTCString()).toISOString();\n    }\n  }\n\n  constructor(initData: SynQLiteOptions) {\n    this._dbName = initData.filename || '';\n    this._db = initData.sqlite3 || undefined;\n    this._synqPrefix = initData.prefix;\n    this._synqTables = initData.tables;\n    this._synqBatchSize = initData.batchSize || this._synqBatchSize;\n    // @TODO: take code from sqlite-example-app to initialise DB\n  }\n\n  async init() {\n    if (this.db) return Promise.resolve(this.db); // @TODO: test DB connection\n    if (!this.dbName) return Promise.reject('No DB filename or connection provided');\n\n    return new Promise(async (resolve, reject) => {\n      try {\n        console.debug('get promiser...')\n        const promiser: any = await new Promise((res) => {\n          const _promiser = sqlite3Worker1Promiser({\n            onready: () => {\n              res(_promiser);\n            },\n            onerror: (err: any) => {\n              console.error('@ERROR', err);\n            },\n            debug: (...args: any) => {\n              console.debug(...args);\n            }\n          });\n        });\n        \n        console.debug('get config...')\n        await promiser('config-get', {});\n\n        let res;\n  \n        try {\n          console.debug(`open ${this.dbName}...`);\n          res = await promiser('open', {\n            filename: `file:${this.dbName}?vfs=opfs`,\n          });\n  \n          console.log(\n            'OPFS is available, created persisted database at',\n            res.result.filename.replace(/^file:(.*?)\\?vfs=opfs$/, '$1'),\n          );\n        }\n        catch(err) {\n          // Probably no vfs\n          res = await promiser('open', {\n            filename: `file:${this.dbName}`\n          });\n          console.log(\n            'OPFS not available, created in-memory database at',\n            res.result.filename, '$1'\n          );\n        }\n  \n        if (!res) return reject('Unable to start DB');\n\n        const { dbId } = res;\n        this._synqDbId = dbId;\n      \n        const conf = await promiser('config-get', {});\n        console.log('Running SQLite3 version', conf.result.version.libVersion);\n        \n        this._db = promiser;\n        resolve(this);\n      }\n      catch(err: any) {\n        if (!(err instanceof Error)) {\n          err = new Error(err.result.message);\n        }\n        console.error(err.name, err.message);\n        console.error(err)\n        reject('DB setup failed.');\n      }\n      console.groupEnd();\n    });\n  };\n\n  get db() {\n    return this._db;\n  }\n\n  get dbName() {\n    return this._dbName;\n  }\n\n  get synqDbId() {\n    return this._synqDbId;\n  }\n\n  get synqPrefix() {\n    return this._synqPrefix;\n  }\n\n  get synqTables() {\n    return this._synqTables;\n  }\n\n  get synqBatchSize() {\n    return this._synqBatchSize;\n  }\n\n  get wal() {\n    return this._wal;\n  }\n\n  async runQuery<T>({sql, values}: {sql: string, values?: any[]}): Promise<T> {\n    const dbId = this.synqDbId;\n    return new Promise((resolve, reject) => {\n      const results: any[] = [];\n      try {\n        this.db('exec', {\n          dbId,\n          sql, // I think we can make this sexier, in Minmail\n          bind: values,\n          callback: (result: any) => {\n            if (!result.row) return resolve(results as any);\n            const o: any = {};\n            result.row.forEach((col: string, i: number) => o[result.columnNames[i]] = result.row[i]);\n            results.push(o);\n          }\n        });\n      }\n      catch(err) {\n        console.error(err);\n        reject(err);\n      }\n    });\n  }\n\n  async getLastSync() {\n    return this.db.exec(`\n      SELECT * FROM ${this.db.synqPrefix}_meta\n      WHERE meta_name = 'last_local_sync'`\n    ).get();\n  }\n  \n  async getChangesSinceLastSync(db: any, lastSync?: string) {\n    let lastLocalSync: string = lastSync || (await this.getLastSync()).last_local_sync;\n    console.debug('@getChangesSinceLastSync', lastLocalSync);\n  \n    let where: string = '';\n  \n    if (lastLocalSync) {\n      where = 'WHERE modified_at > ?'\n    }\n    const sql = `\n    SELECT * FROM ${db.synqPrefix}_changes\n      ${where}\n      ORDER BY modified_at ASC\n    `;\n    const values = lastLocalSync ? [lastLocalSync] : [];\n    console.debug(sql, values);\n  \n    return this.runQuery<Change[]>({sql, values});\n  };\n\n  private async beginTransaction(): Promise<string> {\n    const savepoint = `SP${Date.now()}`;\n    const sql = `SAVEPOINT ${savepoint};`;\n    await this.runQuery({sql});\n    return savepoint\n  }\n\n  private async commitTransaction({savepoint}: {savepoint: string}) {\n    const sql = `RELEASE SAVEPOINT ${savepoint};`;\n    return this.runQuery({sql});\n  }\n\n  private async rollbackTransaction({savepoint}: {savepoint: string}) {\n    const sql = `ROLLBACK TRANSACTION TO SAVEPOINT ${savepoint};`;\n    return this.runQuery({sql}); \n  }\n\n  async applyChange({\n    change,\n    savepoint\n  }: ApplyChangeParams) {\n    try {\n      const table = this.synqTables?.find(t => t.name === change.table_name);\n      let recordData: any;\n      if (change.data) {\n        try {\n          recordData = JSON.parse(change.data);\n        }\n        catch(err) {\n          console.debug(change);\n          throw new Error('Invalid data for insert or update');\n        }\n      }\n        \n      if (!table) throw new Error(`Unable to find table ${change.table_name}`);\n      switch(change.operation) {\n        case 'UPDATE':\n          const columnsToUpdate = Object.keys(recordData).map(key => `${key} = :${key}`).join(', ');\n          const updateValues = { ...recordData, [table.id]: change.row_id};\n          const updateSql = `UPDATE ${change.table_name} SET ${columnsToUpdate} WHERE ${table.id} = :${table.id}`;\n          // console.debug('@performing update... sql:', updateSql, updateValues);\n          await this.runQuery({sql: updateSql, values: updateValues});\n          break;\n        case 'INSERT':\n          const columnsToInsert = Object.keys(recordData).join(',');\n          const insertPlaceholders = Object.keys(recordData).map(k => `:${k}`).join(',')\n          const insertSql = `INSERT OR REPLACE INTO ${change.table_name} (${columnsToInsert}) VALUES (${insertPlaceholders});`;\n          // console.debug('@performing insert... sql:', insertSql, recordData);\n          await this.runQuery({sql: insertSql, values: recordData});\n          break;\n        case 'DELETE':\n          const sql = `DELETE FROM ${change.table_name} WHERE ${table.id} = ?`;\n          await this.runQuery({sql, values: [change.row_id]});\n          break;\n      }\n\n      // @TODO: do we need last_sync_local per table?\n      this.runQuery({\n        sql: `INSERT OR REPLACE INTO ${this.synqPrefix}_meta (meta_name, meta_value) VALUES('last_local_sync', STRFTIME('%Y-%m-%d %H:%M:%f','NOW'))`,\n      });\n    }\n    catch (error) {\n      await this.rollbackTransaction({savepoint})\n      console.error(`Error applying change: ${error}`);\n      throw error; // Throw the error to trigger rollback\n    }\n  }\n  \n  async applyChangesToLocalDB(changes: Change[]) {\n    // Split changes into batches\n    for (let i = 0; i < changes.length; i += this.synqBatchSize) {\n      const batch = changes.slice(i, i + this.synqBatchSize);\n  \n      // Create savepoint and apply each batch within a transaction\n      const savepoint = await this.beginTransaction();\n      try {\n        for (const change of batch) {\n          await this.applyChange({change, savepoint})\n        }\n\n        // Commit the changes for this batch\n        await this.commitTransaction({savepoint});\n\n      } catch (error) {\n        await this.rollbackTransaction({savepoint})\n        console.error(`Transaction failed, changes rolled back: ${error}`);\n        // Handle transaction failure (e.g., log, retry logic, notification)\n      }\n    }\n    console.debug(`Applied ${changes.length} change(s)`)\n  };\n}\n\nexport const setupDatabase = async ({\n  filename,\n  sqlite3,\n  prefix = SYNQLITE_PREFIX,\n  tables,\n  batchSize = SYNQLITE_BATCH_SIZE,\n  wal = false\n}: SynQLiteOptions) => {\n  /*\n  @TODO:\n   - check if DB path exists (throw if not)\n   - check if table names have been provided (throw if not)\n   - check if table names exist (throw if not)\n  */\n  const db = new SynQLite({\n    filename,\n    sqlite3,\n    prefix,\n    tables,\n    batchSize,\n    wal\n  });\n  console.log('@SynQLite db', db)\n  \n  // Initialise the DB\n  try {\n    await db.init();\n  }\n  catch(err) {\n    console.error(err);\n    throw err;\n  }\n\n  prefix = prefix?.trim().replace(/[^a-z0-9]+$/gi, '');\n  console.debug({prefix, batchSize})\n\n  // Add a 'last_modified' column to each table you want to sync, if not already present.\n  // Example for a table named 'items':\n  // db.exec('ALTER TABLE items ADD COLUMN last_modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL');\n\n  // Set WAL mode if necessary\n  if (wal === true) {\n    await db.runQuery({\n      sql: `PRAGMA journal_mode=WAL;`\n    });\n  }\n\n  // Create a change-tracking table\n  await db.runQuery({\n    sql:`\n    CREATE TABLE IF NOT EXISTS ${prefix}_changes (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      table_name TEXT NOT NULL,\n      row_id TEXT NOT NULL,\n      data BLOB,\n      operation TEXT NOT NULL, -- 'INSERT', 'UPDATE', 'DELETE'\n      modified_at TIMESTAMP DATETIME DEFAULT(STRFTIME('%Y-%m-%d %H:%M:%f','NOW'))\n    );`\n  });\n    \n  // Create the index\n  db.runQuery({\n    sql: `CREATE INDEX IF NOT EXISTS ${prefix}_change_modified_idx ON ${prefix}_changes(modified_at)`\n  });\n\n  db.runQuery({\n    sql:`\n    CREATE TABLE IF NOT EXISTS ${prefix}_meta (\n      meta_name TEXT NOT NULL PRIMARY KEY,\n      meta_value TEXT NOT NULL\n    );`\n  });\n  db.runQuery({\n    sql: `CREATE INDEX IF NOT EXISTS ${prefix}_meta_name_idx ON ${prefix}_meta(meta_name)`\n  });\n\n  for (const table of tables) {\n    console.debug('Setting up', table.name, table.id);\n    const jsonObject = (await db.runQuery<any>({\n      sql:`\n      SELECT 'json_object(' || GROUP_CONCAT('''' || name || ''', NEW.' || name, ',') || ')' AS jo\n      FROM pragma_table_info('${table.name}');`\n    }))[0];\n    console.log(jsonObject, jsonObject.jo);\n\n    // Ensure triggers are up to date\n    db.runQuery({sql: `DROP TRIGGER IF EXISTS ${prefix}_after_insert_${table.name}`});\n    db.runQuery({sql: `DROP TRIGGER IF EXISTS ${prefix}_after_update_${table.name}`});\n    db.runQuery({sql: `DROP TRIGGER IF EXISTS ${prefix}_after_delete_${table.name}`});\n\n    const sql = `\n      CREATE TRIGGER IF NOT EXISTS ${prefix}_after_insert_${table.name}\n      AFTER INSERT ON ${table.name}\n      FOR EACH ROW\n      BEGIN\n        INSERT INTO ${prefix}_changes (table_name, row_id, operation, data)\n        VALUES ('${table.name}', NEW.${table.id}, 'INSERT', ${jsonObject.jo});\n      END;`\n      console.log(sql)\n    db.runQuery({sql});\n\n    db.runQuery({\n      sql:`\n      CREATE TRIGGER IF NOT EXISTS ${prefix}_after_update_${table.name}\n      AFTER UPDATE ON ${table.name}\n      FOR EACH ROW\n      BEGIN\n        INSERT INTO ${prefix}_changes (table_name, row_id, operation, data)\n        VALUES ('${table.name}', NEW.${table.id}, 'UPDATE', ${jsonObject.jo});\n      END;`\n    });\n\n    db.runQuery({\n      sql:`\n      CREATE TRIGGER IF NOT EXISTS ${prefix}_after_delete_${table.name}\n      AFTER DELETE ON ${table.name}\n      FOR EACH ROW\n      BEGIN\n        INSERT INTO ${prefix}_changes (table_name, row_id, operation) VALUES ('${table.name}', OLD.${table.id}, 'DELETE');\n      END;`\n    });\n  }\n\n  return db;\n};\n\nexport default setupDatabase;","export const SYNQLITE_PREFIX = 'synql';\nexport const SYNQLITE_BATCH_SIZE = 20;"],"names":["state","value","_Pact","s","o","_settle","bind","pact","then","v","observer","prototype","onFulfilled","onRejected","result","this","callback","e","_this","_iteratorSymbol","Symbol","iterator","_isSettledPact","thenable","_forOf","body","target","step","reject","_cycle","next","done","check","_fixup","TypeError","i","length","array","console","log","sqlite3Worker1Promiser","strtimeAsISO8601","SynQLite","initData","_db","_dbName","_synqDbId","_synqPrefix","_synqTables","_synqBatchSize","_wal","utils","nowAsISO8601","utcNowAsISO8601","Date","toUTCString","toISOString","filename","sqlite3","undefined","prefix","tables","batchSize","_proto","init","db","Promise","resolve","dbName","_exit","_temp4","_result","groupEnd","_temp3","_catch","debug","res","_promiser","onready","onerror","err","error","_console","apply","slice","call","arguments","promiser","_temp2","_reject","dbId","conf","version","libVersion","_temp","_promiser2","replace","_promiser3","Error","message","name","runQuery","_ref","sql","values","_this2","synqDbId","results","row","forEach","col","columnNames","push","getLastSync","exec","synqPrefix","get","getChangesSinceLastSync","lastSync","_temp5","_this4$getLastSync","lastLocalSync","last_local_sync","where","_this4","beginTransaction","savepoint","now","commitTransaction","_ref2","rollbackTransaction","_ref3","applyChange","_ref4","change","_this8","_this8$synqTables","_temp7","recordData","table","synqTables","find","t","table_name","data","JSON","parse","_temp6","_switch","operation","_extends2","columnsToUpdate","Object","keys","map","key","join","updateValues","_extends","id","row_id","columnsToInsert","insertPlaceholders","k","_interrupt","applyChangesToLocalDB","changes","_temp14","_this9","_temp13","test","update","stage","shouldContinue","_resumeAfterTest","_resumeAfterBody","updateValue","_resumeAfterUpdate","_for","synqBatchSize","batch","_temp12","_temp11","_temp10","setupDatabase","_ref5","_ref5$prefix","SYNQLITE_PREFIX","_ref5$batchSize","_ref5$wal","wal","_temp19","_result3","_prefix","_temp17","_temp15","_db$runQuery","jsonObject","jo","trim","_temp16","_temp18"],"mappings":"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"}