!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n(require("@sqlite.org/sqlite-wasm")):"function"==typeof define&&define.amd?define(["@sqlite.org/sqlite-wasm"],n):(e||self).synqliteWeb=n(e.sqliteWasm)}(this,function(e){function n(e){var n=function(e,n){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var t=r.call(e,"string");if("object"!=typeof t)return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof n?n:String(n)}function r(){return r=Object.assign?Object.assign.bind():function(e){for(var n=1;n<arguments.length;n++){var r=arguments[n];for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t])}return e},r.apply(this,arguments)}function t(e,n){try{var r=e()}catch(e){return n(e)}return r&&r.then?r.then(void 0,n):r}function o(e,n,r){if(!e.s){if(r instanceof i){if(!r.s)return void(r.o=o.bind(null,e,n));1&n&&(n=r.s),r=r.v}if(r&&r.then)return void r.then(o.bind(null,e,n),o.bind(null,e,2));e.s=n,e.v=r;var t=e.o;t&&t(e)}}var i=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(n,r){var t=new e,i=this.s;if(i){var a=1&i?n:r;if(a){try{o(t,1,a(this.v))}catch(e){o(t,2,e)}return t}return this}return this.o=function(e){try{var i=e.v;1&e.s?o(t,1,n?n(i):i):r?o(t,1,r(i)):o(t,2,i)}catch(e){o(t,2,e)}},t},e}(),a="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function s(e){return e instanceof i&&1&e.s}function u(e,n,r){if("function"==typeof e[a]){var t,u,c,l=e[a]();if(function e(a){try{for(;!((t=l.next()).done||r&&r());)if((a=n(t.value))&&a.then){if(!s(a))return void a.then(e,c||(c=o.bind(null,u=new i,2)));a=a.v}u?o(u,1,a):u=a}catch(e){o(u||(u=new i),2,e)}}(),l.return){var f=function(e){try{t.done||l.return()}catch(e){}return e};if(u&&u.then)return u.then(f,function(e){throw f(e)});f()}return u}if(!("length"in e))throw new TypeError("Object is not iterable");for(var h=[],v=0;v<e.length;v++)h.push(e[v]);return function(e,n,r){var t,a,u=-1;return function c(l){try{for(;++u<e.length&&(!r||!r());)if((l=n(u))&&l.then){if(!s(l))return void l.then(c,a||(a=o.bind(null,t=new i,2)));l=l.v}t?o(t,1,l):t=l}catch(e){o(t||(t=new i),2,e)}}(),t}(h,function(e){return n(h[e])},r)}console.log({sqlite3Worker1Promiser:e.sqlite3Worker1Promiser});var c="STRFTIME('%Y-%m-%dT%H:%M:%f','NOW')",l=/*#__PURE__*/function(){function a(e){this._db=void 0,this._dbName=void 0,this._synqDbId=void 0,this._synqPrefix=void 0,this._synqTables=void 0,this._synqBatchSize=20,this._wal=!1,this.utils={strtimeAsISO8601:c,nowAsISO8601:c,utcNowAsISO8601:function(){return new Date((new Date).toUTCString()).toISOString()}},this._dbName=e.filename||"",this._db=e.sqlite3||void 0,this._synqPrefix=e.prefix,this._synqTables=e.tables,this._synqBatchSize=e.batchSize||this._synqBatchSize}var l,f,h=a.prototype;return h.init=function(){try{var n=this;return n.db?Promise.resolve(n.db):n.dbName?Promise.resolve(new Promise(function(r,o){try{var i,a=function(e){if(i)return e;console.groupEnd()},s=t(function(){return console.debug("get promiser..."),Promise.resolve(new Promise(function(n){var r=e.sqlite3Worker1Promiser({onready:function(){n(r)},onerror:function(e){console.error("@ERROR",e)},debug:function(){var e;(e=console).debug.apply(e,[].slice.call(arguments))}})})).then(function(e){return console.debug("get config..."),Promise.resolve(e("config-get",{})).then(function(){function a(){if(!s){var t=o("Unable to start DB");return i=1,t}return n._synqDbId=s.dbId,Promise.resolve(e("config-get",{})).then(function(t){console.log("Running SQLite3 version",t.result.version.libVersion),n._db=e,r(n)})}var s,u=t(function(){return console.debug("open "+n.dbName+"..."),Promise.resolve(e("open",{filename:"file:"+n.dbName+"?vfs=opfs"})).then(function(e){s=e,console.log("OPFS is available, created persisted database at",s.result.filename.replace(/^file:(.*?)\?vfs=opfs$/,"$1"))})},function(){return Promise.resolve(e("open",{filename:"file:"+n.dbName})).then(function(e){s=e,console.log("OPFS not available, created in-memory database at",s.result.filename,"$1")})});return u&&u.then?u.then(a):a()})})},function(e){e instanceof Error||(e=new Error(e.result.message)),console.error(e.name,e.message),console.error(e),o("DB setup failed.")});return Promise.resolve(s&&s.then?s.then(a):a(s))}catch(e){return Promise.reject(e)}})):Promise.reject("No DB filename or connection provided")}catch(e){return Promise.reject(e)}},h.runQuery=function(e){var n=e.sql,r=e.values;try{var t=this,o=t.synqDbId;return Promise.resolve(new Promise(function(e,i){var a=[];try{t.db("exec",{dbId:o,sql:n,bind:r,callback:function(n){if(!n.row)return e(a);var r={};n.row.forEach(function(e,t){return r[n.columnNames[t]]=n.row[t]}),a.push(r)}})}catch(e){console.error(e),i(e)}}))}catch(e){return Promise.reject(e)}},h.getLastSync=function(){try{return Promise.resolve(this.db.exec("\n      SELECT * FROM "+this.db.synqPrefix+"_meta\n      WHERE meta_name = 'last_local_sync'").get())}catch(e){return Promise.reject(e)}},h.getChangesSinceLastSync=function(e,n){try{var r=function(r){var o=n||r.last_local_sync;console.debug("@getChangesSinceLastSync",o);var i="";o&&(i="WHERE modified_at > ?");var a="\n    SELECT * FROM "+e.synqPrefix+"_changes\n      "+i+"\n      ORDER BY modified_at ASC\n    ",s=o?[o]:[];return console.debug(a,s),t.runQuery({sql:a,values:s})},t=this;return Promise.resolve(n?r(n):Promise.resolve(t.getLastSync()).then(r))}catch(e){return Promise.reject(e)}},h.beginTransaction=function(){try{var e="SP"+Date.now();return Promise.resolve(this.runQuery({sql:"SAVEPOINT "+e+";"})).then(function(){return e})}catch(e){return Promise.reject(e)}},h.commitTransaction=function(e){var n=e.savepoint;try{return Promise.resolve(this.runQuery({sql:"RELEASE SAVEPOINT "+n+";"}))}catch(e){return Promise.reject(e)}},h.rollbackTransaction=function(e){var n=e.savepoint;try{return Promise.resolve(this.runQuery({sql:"ROLLBACK TRANSACTION TO SAVEPOINT "+n+";"}))}catch(e){return Promise.reject(e)}},h.applyChange=function(e){var n=e.change,a=e.savepoint;try{var s=this;return Promise.resolve(t(function(){var e;function t(){s.runQuery({sql:"INSERT OR REPLACE INTO "+s.synqPrefix+"_meta (meta_name, meta_value) VALUES('last_local_sync', STRFTIME('%Y-%m-%d %H:%M:%f','NOW'))"})}var a,u=null==(e=s.synqTables)?void 0:e.find(function(e){return e.name===n.table_name});if(n.data)try{a=JSON.parse(n.data)}catch(e){throw console.debug(n),new Error("Invalid data for insert or update")}if(!u)throw new Error("Unable to find table "+n.table_name);var c=function(e,n){var r,t=-1;e:{for(var a=0;a<n.length;a++){var s=n[a][0];if(s){var u=s();if(u&&u.then)break e;if(u===e){t=a;break}}else t=a}if(-1!==t){do{for(var c=n[t][1];!c;)t++,c=n[t][1];var l=c();if(l&&l.then){r=!0;break e}var f=n[t][2];t++}while(f&&!f());return l}}var h=new i,v=o.bind(null,h,2);return(r?l.then(d):u.then(function r(i){for(;;){if(i===e){t=a;break}if(++a===n.length){if(-1!==t)break;return void o(h,1,c)}if(s=n[a][0]){if((i=s())&&i.then)return void i.then(r).then(void 0,v)}else t=a}do{for(var u=n[t][1];!u;)t++,u=n[t][1];var c=u();if(c&&c.then)return void c.then(d).then(void 0,v);var l=n[t][2];t++}while(l&&!l());o(h,1,c)})).then(void 0,v),h;function d(e){for(;;){var r=n[t][2];if(!r||r())break;t++;for(var i=n[t][1];!i;)t++,i=n[t][1];if((e=i())&&e.then)return void e.then(d).then(void 0,v)}o(h,1,e)}}(n.operation,[[function(){return"UPDATE"},function(){var e,t=Object.keys(a).map(function(e){return e+" = :"+e}).join(", "),o=r({},a,((e={})[u.id]=n.row_id,e));return Promise.resolve(s.runQuery({sql:"UPDATE "+n.table_name+" SET "+t+" WHERE "+u.id+" = :"+u.id,values:o})).then(function(){})}],[function(){return"INSERT"},function(){var e=Object.keys(a).join(","),r=Object.keys(a).map(function(e){return":"+e}).join(",");return Promise.resolve(s.runQuery({sql:"INSERT OR REPLACE INTO "+n.table_name+" ("+e+") VALUES ("+r+");",values:a})).then(function(){})}],[function(){return"DELETE"},function(){return Promise.resolve(s.runQuery({sql:"DELETE FROM "+n.table_name+" WHERE "+u.id+" = ?",values:[n.row_id]})).then(function(){})}]]);return c&&c.then?c.then(t):t()},function(e){return Promise.resolve(s.rollbackTransaction({savepoint:a})).then(function(){throw console.error("Error applying change: "+e),e})}))}catch(e){return Promise.reject(e)}},h.applyChangesToLocalDB=function(e){try{var n=function(){console.debug("Applied "+e.length+" change(s)")},r=this,a=0,c=function(e,n,r){for(var t;;){var a=e();if(s(a)&&(a=a.v),!a)return u;if(a.then){t=0;break}var u=r();if(u&&u.then){if(!s(u)){t=1;break}u=u.s}if(n){var c=n();if(c&&c.then&&!s(c)){t=2;break}}}var l=new i,f=o.bind(null,l,2);return(0===t?a.then(v):1===t?u.then(h):c.then(d)).then(void 0,f),l;function h(t){u=t;do{if(n&&(c=n())&&c.then&&!s(c))return void c.then(d).then(void 0,f);if(!(a=e())||s(a)&&!a.v)return void o(l,1,u);if(a.then)return void a.then(v).then(void 0,f);s(u=r())&&(u=u.v)}while(!u||!u.then);u.then(h).then(void 0,f)}function v(e){e?(u=r())&&u.then?u.then(h).then(void 0,f):h(u):o(l,1,u)}function d(){(a=e())?a.then?a.then(v).then(void 0,f):v(a):o(l,1,u)}}(function(){return a<e.length},function(){return!!(a+=r.synqBatchSize)},function(){var n=e.slice(a,a+r.synqBatchSize);return Promise.resolve(r.beginTransaction()).then(function(e){var o=t(function(){function t(){return Promise.resolve(r.commitTransaction({savepoint:e})).then(function(){})}var o=u(n,function(n){return Promise.resolve(r.applyChange({change:n,savepoint:e})).then(function(){})});return o&&o.then?o.then(t):t()},function(n){return Promise.resolve(r.rollbackTransaction({savepoint:e})).then(function(){console.error("Transaction failed, changes rolled back: "+n)})});if(o&&o.then)return o.then(function(){})})});return Promise.resolve(c&&c.then?c.then(n):n())}catch(e){return Promise.reject(e)}},l=a,(f=[{key:"db",get:function(){return this._db}},{key:"dbName",get:function(){return this._dbName}},{key:"synqDbId",get:function(){return this._synqDbId}},{key:"synqPrefix",get:function(){return this._synqPrefix}},{key:"synqTables",get:function(){return this._synqTables}},{key:"synqBatchSize",get:function(){return this._synqBatchSize}},{key:"wal",get:function(){return this._wal}}])&&function(e,r){for(var t=0;t<r.length;t++){var o=r[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,n(o.key),o)}}(l.prototype,f),Object.defineProperty(l,"prototype",{writable:!1}),a}();return function(e){var n=e.filename,r=e.sqlite3,o=e.prefix,i=void 0===o?"synql":o,a=e.tables,s=e.batchSize,c=void 0===s?20:s,f=e.wal,h=void 0!==f&&f;try{var v=function(e){var n;function r(){return Promise.resolve(d.runQuery({sql:"\n    CREATE TABLE IF NOT EXISTS "+i+"_changes (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      table_name TEXT NOT NULL,\n      row_id TEXT NOT NULL,\n      data BLOB,\n      operation TEXT NOT NULL, -- 'INSERT', 'UPDATE', 'DELETE'\n      modified_at TIMESTAMP DATETIME DEFAULT(STRFTIME('%Y-%m-%d %H:%M:%f','NOW'))\n    );"})).then(function(){d.runQuery({sql:"CREATE INDEX IF NOT EXISTS "+i+"_change_modified_idx ON "+i+"_changes(modified_at)"}),d.runQuery({sql:"\n    CREATE TABLE IF NOT EXISTS "+i+"_meta (\n      meta_name TEXT NOT NULL PRIMARY KEY,\n      meta_value TEXT NOT NULL\n    );"}),d.runQuery({sql:"CREATE INDEX IF NOT EXISTS "+i+"_meta_name_idx ON "+i+"_meta(meta_name)"});var e=u(a,function(e){return console.debug("Setting up",e.name,e.id),Promise.resolve(d.runQuery({sql:"\n      SELECT 'json_object(' || GROUP_CONCAT('''' || name || ''', NEW.' || name, ',') || ')' AS jo\n      FROM pragma_table_info('"+e.name+"');"})).then(function(n){var r=n[0];console.log(r,r.jo),d.runQuery({sql:"DROP TRIGGER IF EXISTS "+i+"_after_insert_"+e.name}),d.runQuery({sql:"DROP TRIGGER IF EXISTS "+i+"_after_update_"+e.name}),d.runQuery({sql:"DROP TRIGGER IF EXISTS "+i+"_after_delete_"+e.name});var t="\n      CREATE TRIGGER IF NOT EXISTS "+i+"_after_insert_"+e.name+"\n      AFTER INSERT ON "+e.name+"\n      FOR EACH ROW\n      BEGIN\n        INSERT INTO "+i+"_changes (table_name, row_id, operation, data)\n        VALUES ('"+e.name+"', NEW."+e.id+", 'INSERT', "+r.jo+");\n      END;";console.log(t),d.runQuery({sql:t}),d.runQuery({sql:"\n      CREATE TRIGGER IF NOT EXISTS "+i+"_after_update_"+e.name+"\n      AFTER UPDATE ON "+e.name+"\n      FOR EACH ROW\n      BEGIN\n        INSERT INTO "+i+"_changes (table_name, row_id, operation, data)\n        VALUES ('"+e.name+"', NEW."+e.id+", 'UPDATE', "+r.jo+");\n      END;"}),d.runQuery({sql:"\n      CREATE TRIGGER IF NOT EXISTS "+i+"_after_delete_"+e.name+"\n      AFTER DELETE ON "+e.name+"\n      FOR EACH ROW\n      BEGIN\n        INSERT INTO "+i+"_changes (table_name, row_id, operation) VALUES ('"+e.name+"', OLD."+e.id+", 'DELETE');\n      END;"})})});return e&&e.then?e.then(function(){return d}):d})}i=null==(n=i)?void 0:n.trim().replace(/[^a-z0-9]+$/gi,""),console.debug({prefix:i,batchSize:c});var t=function(){if(!0===h)return Promise.resolve(d.runQuery({sql:"PRAGMA journal_mode=WAL;"})).then(function(){})}();return t&&t.then?t.then(r):r()},d=new l({filename:n,sqlite3:r,prefix:i,tables:a,batchSize:c,wal:h});console.log("@SynQLite db",d);var m=t(function(){return Promise.resolve(d.init()).then(function(){})},function(e){throw console.error(e),e});return Promise.resolve(m&&m.then?m.then(v):v())}catch(e){return Promise.reject(e)}}});
//# sourceMappingURL=synqlite.umd.js.map
