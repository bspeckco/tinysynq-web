var e,n=require("@sqlite.org/sqlite-wasm"),r=require("tslog");function t(e){var n=function(e,n){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var t=r.call(e,"string");if("object"!=typeof t)return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof n?n:String(n)}function i(){return i=Object.assign?Object.assign.bind():function(e){for(var n=1;n<arguments.length;n++){var r=arguments[n];for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t])}return e},i.apply(this,arguments)}function o(e,n){try{var r=e()}catch(e){return n(e)}return r&&r.then?r.then(void 0,n):r}!function(e){e[e.Silly=0]="Silly",e[e.Trace=1]="Trace",e[e.Debug=2]="Debug",e[e.Info=3]="Info",e[e.Warn=4]="Warn",e[e.Error=5]="Error",e[e.Fatal=6]="Fatal"}(e||(e={}));var a=new r.Logger({name:"synqlite-web-init",minLevel:e.Info});function u(e,n,r){if(!e.s){if(r instanceof l){if(!r.s)return void(r.o=u.bind(null,e,n));1&n&&(n=r.s),r=r.v}if(r&&r.then)return void r.then(u.bind(null,e,n),u.bind(null,e,2));e.s=n,e.v=r;var t=e.o;t&&t(e)}}var s="STRFTIME('%Y-%m-%dT%H:%M:%f','NOW')";const l=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(n,r){const t=new e,i=this.s;if(i){const e=1&i?n:r;if(e){try{u(t,1,e(this.v))}catch(e){u(t,2,e)}return t}return this}return this.o=function(e){try{const i=e.v;1&e.s?u(t,1,n?n(i):i):r?u(t,1,r(i)):u(t,2,i)}catch(e){u(t,2,e)}},t},e}();var c="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function f(e){return e instanceof l&&1&e.s}function h(e,n,r){if("function"==typeof e[c]){var t,i,o,a=e[c]();if(function e(s){try{for(;!((t=a.next()).done||r&&r());)if((s=n(t.value))&&s.then){if(!f(s))return void s.then(e,o||(o=u.bind(null,i=new l,2)));s=s.v}i?u(i,1,s):i=s}catch(e){u(i||(i=new l),2,e)}}(),a.return){var s=function(e){try{t.done||a.return()}catch(e){}return e};if(i&&i.then)return i.then(s,function(e){throw s(e)});s()}return i}if(!("length"in e))throw new TypeError("Object is not iterable");for(var h=[],v=0;v<e.length;v++)h.push(e[v]);return function(e,n,r){var t,i,o=-1;return function a(s){try{for(;++o<e.length&&(!r||!r());)if((s=n(o))&&s.then){if(!f(s))return void s.then(a,i||(i=u.bind(null,t=new l,2)));s=s.v}t?u(t,1,s):t=s}catch(e){u(t||(t=new l),2,e)}}(),t}(h,function(e){return n(h[e])},r)}var v=/*#__PURE__*/function(){function a(n){var t;this._db=void 0,this._dbName=void 0,this._synqDbId=void 0,this._synqPrefix=void 0,this._synqTables=void 0,this._synqBatchSize=20,this._wal=!1,this.log=void 0,this.utils={strtimeAsISO8601:s,nowAsISO8601:s,utcNowAsISO8601:function(){return new Date((new Date).toUTCString()).toISOString()}},this._dbName=n.filename||"",this._db=n.sqlite3||void 0,this._synqPrefix=n.prefix,this._synqTables=n.tables,this._synqBatchSize=n.batchSize||this._synqBatchSize,this._wal=null!=(t=n.wal)&&t,this.log=new r.Logger(i({name:"synqlite-web",minLevel:e.Info,type:"json",maskValuesOfKeys:["password","encryption_key"],hideLogPositionForProduction:!0},n.logOptions||{}))}var c,v,m=a.prototype;return m.init=function(){try{var e=this,r=e;return e.db?Promise.resolve(e.db):e.dbName?Promise.resolve(new Promise(function(t,i){try{return Promise.resolve(o(function(){return e.log.debug("get promiser..."),Promise.resolve(new Promise(function(t){var i=n.sqlite3Worker1Promiser({onready:function(){t(i)},onerror:function(n){e.log.error("@ERROR",n)},debug:function(){var e;(e=r.log).debug.apply(e,[].slice.call(arguments))},onunhandled:function(n){e.log.error("@UNHANDLED",n)}})})).then(function(n){return e.log.debug("get config..."),Promise.resolve(n("config-get",{})).then(function(){function r(){return a?(e._synqDbId=a.dbId,Promise.resolve(n("config-get",{})).then(function(r){e.log.info("Running SQLite3 version",r.result.version.libVersion),e._db=n,t(e)})):i("Unable to start DB")}var a,u=o(function(){return e.log.debug("open "+e.dbName+"..."),Promise.resolve(n("open",{filename:"file:"+e.dbName+"?vfs=opfs"})).then(function(n){e.log.info("OPFS is available, created persisted database at",(a=n).result.filename.replace(/^file:(.*?)\?vfs=opfs$/,"$1"))})},function(){return Promise.resolve(n("open",{filename:"file:"+e.dbName})).then(function(n){e.log.info("OPFS not available, created in-memory database at",(a=n).result.filename,"$1")})});return u&&u.then?u.then(r):r()})})},function(n){n instanceof Error||(n=new Error(n.result.message)),e.log.error(n.name,n.message),e.log.error(n),i("DB setup failed.")}))}catch(e){return Promise.reject(e)}})):Promise.reject("No DB filename or connection provided")}catch(e){return Promise.reject(e)}},m.runQuery=function(e){var n=e.sql,r=e.values;try{var t=this,i=Math.ceil(1e6*Math.random());t.log.debug("@runQuery",i,n,r,"/");var o=t.synqDbId;return Promise.resolve(new Promise(function(e,a){var u=[];try{t.db("exec",{dbId:o,sql:n,bind:r,callback:function(n){if(!n.row)return t.log.debug("@runQuery RESOLVED",i),e(u);var r={};n.row.forEach(function(e,t){return r[n.columnNames[t]]=n.row[t]}),u.push(r)}})}catch(e){t.log.error(i,e),a(e)}}))}catch(e){return Promise.reject(e)}},m.getLastSync=function(){try{return Promise.resolve(this.runQuery({sql:"\n        SELECT * FROM "+this.synqPrefix+"_meta\n        WHERE meta_name = 'last_local_sync'"})).then(function(e){return e[0]})}catch(e){return Promise.reject(e)}},m.getChangesSinceLastSync=function(e){var n=e.lastSync;try{var r=function(e){var r=n||e.last_local_sync;t.log.debug("@getChangesSinceLastSync",r);var i="";r&&(i="WHERE modified_at > ?");var o="\n    SELECT * FROM "+t.synqPrefix+"_changes\n      "+i+"\n      ORDER BY modified_at ASC\n    ",a=r?[r]:[];return t.log.debug(o,a),t.runQuery({sql:o,values:a})},t=this;return Promise.resolve(n?r(n):Promise.resolve(t.getLastSync()).then(r))}catch(e){return Promise.reject(e)}},m.enableTriggers=function(){return this.runQuery({sql:"\n      INSERT OR REPLACE INTO "+this.synqPrefix+"_meta (meta_name, meta_value)\n      VALUES ('triggers_on', '1')\n      RETURNING *;\n      "})},m.disableTriggers=function(){return this.runQuery({sql:"\n      INSERT OR REPLACE INTO "+this.synqPrefix+"_meta (meta_name, meta_value)\n      VALUES ('triggers_on', '0')\n      RETURNING *;\n      "})},m.beginTransaction=function(){try{var e="SP"+Date.now();return Promise.resolve(this.runQuery({sql:"SAVEPOINT "+e+";"})).then(function(){return e})}catch(e){return Promise.reject(e)}},m.commitTransaction=function(e){var n=e.savepoint;try{return Promise.resolve(this.runQuery({sql:"RELEASE SAVEPOINT "+n+";"}))}catch(e){return Promise.reject(e)}},m.rollbackTransaction=function(e){var n=e.savepoint;try{return Promise.resolve(this.runQuery({sql:"ROLLBACK TRANSACTION TO SAVEPOINT "+n+";"}))}catch(e){return Promise.reject(e)}},m.applyChange=function(e){var n=e.change,r=e.savepoint;try{var t=this;return Promise.resolve(o(function(){var e;function r(){t.runQuery({sql:"INSERT OR REPLACE INTO "+t.synqPrefix+"_meta (meta_name, meta_value) VALUES('last_local_sync', STRFTIME('%Y-%m-%d %H:%M:%f','NOW'))"})}var o,a=null==(e=t.synqTables)?void 0:e.find(function(e){return e.name===n.table_name});if(n.data)try{o=JSON.parse(n.data)}catch(e){throw t.log.debug(n),new Error("Invalid data for insert or update")}if(!a)throw new Error("Unable to find table "+n.table_name);var s=function(e,n){var r,t=-1;e:{for(var i=0;i<n.length;i++){var o=n[i][0];if(o){var a=o();if(a&&a.then)break e;if(a===e){t=i;break}}else t=i}if(-1!==t){do{for(var s=n[t][1];!s;)t++,s=n[t][1];var c=s();if(c&&c.then){r=!0;break e}var f=n[t][2];t++}while(f&&!f());return c}}var h=new l,v=u.bind(null,h,2);return(r?c.then(m):a.then(function r(a){for(;;){if(a===e){t=i;break}if(++i===n.length){if(-1!==t)break;return void u(h,1,l)}if(o=n[i][0]){if((a=o())&&a.then)return void a.then(r).then(void 0,v)}else t=i}do{for(var s=n[t][1];!s;)t++,s=n[t][1];var l=s();if(l&&l.then)return void l.then(m).then(void 0,v);var c=n[t][2];t++}while(c&&!c());u(h,1,l)})).then(void 0,v),h;function m(e){for(;;){var r=n[t][2];if(!r||r())break;t++;for(var i=n[t][1];!i;)t++,i=n[t][1];if((e=i())&&e.then)return void e.then(m).then(void 0,v)}u(h,1,e)}}(n.operation,[[function(){return"UPDATE"},function(){var e,r=Object.keys(o).map(function(e){return e+" = :"+e}).join(", "),u=i({},o,((e={})[a.id]=n.row_id,e));return Promise.resolve(t.runQuery({sql:"UPDATE "+n.table_name+" SET "+r+" WHERE "+a.id+" = :"+a.id,values:u})).then(function(){})}],[function(){return"INSERT"},function(){var e=Object.keys(o).join(","),r=Object.keys(o).map(function(e){return":"+e}).join(",");return Promise.resolve(t.runQuery({sql:"INSERT OR REPLACE INTO "+n.table_name+" ("+e+") VALUES ("+r+");",values:o})).then(function(){})}],[function(){return"DELETE"},function(){return Promise.resolve(t.runQuery({sql:"DELETE FROM "+n.table_name+" WHERE "+a.id+" = ?",values:[n.row_id]})).then(function(){})}]]);return s&&s.then?s.then(r):r()},function(e){return Promise.resolve(t.rollbackTransaction({savepoint:r})).then(function(){throw t.log.error("Error applying change: "+e),e})}))}catch(e){return Promise.reject(e)}},m.applyChangesToLocalDB=function(e){try{var n=this;return Promise.resolve(n.disableTriggers()).then(function(){function r(){return Promise.resolve(n.enableTriggers()).then(function(){n.log.debug("Applied "+e.length+" change(s)")})}var t=0,i=function(e,n,r){for(var t;;){var i=e();if(f(i)&&(i=i.v),!i)return o;if(i.then){t=0;break}var o=r();if(o&&o.then){if(!f(o)){t=1;break}o=o.s}if(n){var a=n();if(a&&a.then&&!f(a)){t=2;break}}}var s=new l,c=u.bind(null,s,2);return(0===t?i.then(v):1===t?o.then(h):a.then(m)).then(void 0,c),s;function h(t){o=t;do{if(n&&(a=n())&&a.then&&!f(a))return void a.then(m).then(void 0,c);if(!(i=e())||f(i)&&!i.v)return void u(s,1,o);if(i.then)return void i.then(v).then(void 0,c);f(o=r())&&(o=o.v)}while(!o||!o.then);o.then(h).then(void 0,c)}function v(e){e?(o=r())&&o.then?o.then(h).then(void 0,c):h(o):u(s,1,o)}function m(){(i=e())?i.then?i.then(v).then(void 0,c):v(i):u(s,1,o)}}(function(){return t<e.length},function(){return!!(t+=n.synqBatchSize)},function(){var r=e.slice(t,t+n.synqBatchSize);return Promise.resolve(n.beginTransaction()).then(function(e){var t=o(function(){function t(){return Promise.resolve(n.commitTransaction({savepoint:e})).then(function(){})}var i=h(r,function(r){return Promise.resolve(n.applyChange({change:r,savepoint:e})).then(function(){})});return i&&i.then?i.then(t):t()},function(r){return Promise.resolve(n.rollbackTransaction({savepoint:e})).then(function(){n.log.error("Transaction failed, changes rolled back: "+r)})});if(t&&t.then)return t.then(function(){})})});return i&&i.then?i.then(r):r()})}catch(e){return Promise.reject(e)}},m.setupTriggersForTable=function(e){var n=e.table;try{var r=this;return r.log.debug("Setting up triggers for",n.name),Promise.resolve(r.runQuery({sql:"DROP TRIGGER IF EXISTS "+r.synqPrefix+"_after_insert_"+n.name})).then(function(){return Promise.resolve(r.runQuery({sql:"DROP TRIGGER IF EXISTS "+r.synqPrefix+"_after_update_"+n.name})).then(function(){return Promise.resolve(r.runQuery({sql:"DROP TRIGGER IF EXISTS "+r.synqPrefix+"_after_delete_"+n.name})).then(function(){return Promise.resolve(r.runQuery({sql:"\n      SELECT 'json_object(' || GROUP_CONCAT('''' || name || ''', NEW.' || name, ',') || ')' AS jo\n      FROM pragma_table_info('"+n.name+"');"})).then(function(e){var t=e[0];return r.log.debug("@jsonObject",JSON.stringify(t,null,2)),Promise.resolve(r.runQuery({sql:"\n      CREATE TRIGGER IF NOT EXISTS "+r.synqPrefix+"_after_insert_"+n.name+"\n      AFTER INSERT ON "+n.name+"\n      FOR EACH ROW\n      WHEN (SELECT meta_value FROM synqlite_meta WHERE meta_name = 'triggers_on')='1'\n      BEGIN\n        INSERT INTO "+r.synqPrefix+"_changes (table_name, row_id, operation, data)\n        VALUES ('"+n.name+"', NEW."+n.id+", 'INSERT', "+t.jo+");\n      END;"})).then(function(){return Promise.resolve(r.runQuery({sql:"\n      CREATE TRIGGER IF NOT EXISTS "+r.synqPrefix+"_after_update_"+n.name+"\n      AFTER UPDATE ON "+n.name+"\n      FOR EACH ROW\n      WHEN (SELECT meta_value FROM synqlite_meta WHERE meta_name = 'triggers_on')='1'\n      BEGIN\n        INSERT INTO "+r.synqPrefix+"_changes (table_name, row_id, operation, data)\n        VALUES ('"+n.name+"', NEW."+n.id+", 'UPDATE', "+t.jo+");\n      END;"})).then(function(){return Promise.resolve(r.runQuery({sql:"\n      CREATE TRIGGER IF NOT EXISTS "+r.synqPrefix+"_after_delete_"+n.name+"\n      AFTER DELETE ON "+n.name+"\n      FOR EACH ROW\n      WHEN (SELECT meta_value FROM synqlite_meta WHERE meta_name = 'triggers_on')='1'\n      BEGIN\n        INSERT INTO "+r.synqPrefix+"_changes (table_name, row_id, operation) VALUES ('"+n.name+"', OLD."+n.id+", 'DELETE');\n      END;"})).then(function(){return Promise.resolve(r.enableTriggers()).then(function(){r.log.debug("@@@\nTriggers ready\n@@@")})})})})})})})})}catch(e){return Promise.reject(e)}},c=a,(v=[{key:"db",get:function(){return this._db}},{key:"dbName",get:function(){return this._dbName}},{key:"synqDbId",get:function(){return this._synqDbId}},{key:"synqPrefix",get:function(){return this._synqPrefix}},{key:"synqTables",get:function(){return this._synqTables}},{key:"synqBatchSize",get:function(){return this._synqBatchSize}},{key:"wal",get:function(){return this._wal}}])&&function(e,n){for(var r=0;r<n.length;r++){var i=n[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,t(i.key),i)}}(c.prototype,v),Object.defineProperty(c,"prototype",{writable:!1}),a}();module.exports=function(e){var n=e.filename,r=e.sqlite3,t=e.prefix,i=void 0===t?"synql":t,u=e.tables,s=e.batchSize,l=void 0===s?20:s,c=e.wal,f=void 0!==c&&c,m=e.preInit,d=void 0===m?[]:m,E=e.postInit,g=void 0===E?[]:E,y=e.logOptions;try{var T=function(e){var n;function r(){function e(){return Promise.resolve(b.runQuery({sql:"\n    CREATE TABLE IF NOT EXISTS "+i+"_changes (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      table_name TEXT NOT NULL,\n      row_id TEXT NOT NULL,\n      data BLOB,\n      operation TEXT NOT NULL, -- 'INSERT', 'UPDATE', 'DELETE'\n      modified_at TIMESTAMP DATETIME DEFAULT(STRFTIME('%Y-%m-%d %H:%M:%f','NOW'))\n    );"})).then(function(){var e;b.runQuery({sql:"CREATE INDEX IF NOT EXISTS "+i+"_change_modified_idx ON "+i+"_changes(modified_at)"}),b.runQuery({sql:"\n    CREATE TABLE IF NOT EXISTS "+i+"_meta (\n      meta_name TEXT NOT NULL PRIMARY KEY,\n      meta_value TEXT NOT NULL\n    );"}),b.runQuery({sql:"CREATE INDEX IF NOT EXISTS "+i+"_meta_name_idx ON "+i+"_meta(meta_name)"});var n=o(function(){function e(){var e=function(){if((null==g?void 0:g.length)>0){var e=h(g,function(e){return a.debug("@@@\npostInit\n"+e+"\n@@@"),Promise.resolve(b.runQuery({sql:e})).then(function(){})});if(e&&e.then)return e.then(function(){})}}();if(e&&e.then)return e.then(function(){})}var n=h(u,function(e){return Promise.resolve(b.setupTriggersForTable({table:e})).then(function(){})});return n&&n.then?n.then(e):e()},function(n){return a.error("Failed to setup triggers",n),e=1,null});return n&&n.then?n.then(function(n){return e?n:b}):e?n:b})}var n=function(){if((null==d?void 0:d.length)>0){var e=h(d,function(e){return a.debug("@@@\npreInit\n"+e+"\n@@@"),Promise.resolve(b.runQuery({sql:e})).then(function(){})});if(e&&e.then)return e.then(function(){})}}();return n&&n.then?n.then(e):e()}i=null==(n=i)?void 0:n.trim().replace(/[^a-z0-9]+$/gi,""),a.debug({prefix:i,batchSize:l});var t=function(){if(!0===f)return Promise.resolve(b.runQuery({sql:"PRAGMA journal_mode=WAL;"})).then(function(){})}();return t&&t.then?t.then(r):r()},b=new v({filename:n,sqlite3:r,prefix:i,tables:u,batchSize:l,wal:f,logOptions:y});a.debug("@SynQLite db",b);var _=o(function(){return Promise.resolve(b.init()).then(function(){})},function(e){throw a.error(e),e});return Promise.resolve(_&&_.then?_.then(T):T())}catch(e){return Promise.reject(e)}};
//# sourceMappingURL=synqlite.cjs.map
